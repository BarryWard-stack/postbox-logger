# Handover: Heritage Postbox Logger v0.9.1

© 2025 Insight Geospatial, Eurotech Marine Data Services Ltd. All rights reserved.

**Date:** 18 February 2026  
**From:** Cursor session (user hit usage limits; limited tokens in auto mode)  
**For:** Gemini (Architect) and Claude (Developer)  
**Project:** Heritage Postbox Logger — Philately Alpha

---

## 1. Current State Summary

- **Version:** v0.9.1 (Alpha) — code and labels updated.
- **Live URLs:**
  - **Firebase:** https://heritage-postbox.web.app
  - **GitHub Pages:** https://barryward2070-dotcom.github.io/heritage-postbox/
- **Deployment:** Firebase now deploys from a **`public/`** folder only (~44 files). Root ignore was failing; switching to `public` fixed deploy size (was 1273+ files, now ~44).
- **Working:** Tab title "Heritage Postbox v0.9.1 (Alpha)", version badge in header, app loads, 56 requests on load, Firebase Hosting serving correct set of files.
- **Not working on live site (user report):**
  - **Icons** in Add Postbox → Visual Mode not showing.
  - **Blue dot** (user location) not pulsating.
  - **Directions** button (SatNav) not visible/working on map popups.

---

## 2. Architecture & Key Files

- **App entry:** `index.html` — Firebase (module), then sync scripts in `<head>`: React, ReactDOM, Leaflet, `postboxAssets.js`, `postcard-engine.js`. Then `initApp()` runs (must be called after Firebase setup).
- **Core logic:** All in `index.html` (no separate bundle): `PostboxLogger`, `MapView`, `PostboxForm`, `PostboxList`, etc. Uses `getPostboxTypeConfig()` from `postboxAssets.js`.
- **Assets config:** `postboxAssets.js` — `postboxTypes` (and helpers). Contains Visual Field Guide fields: `visualMarkers`, `cipherDetails`, `validationQuestion` for key types.
- **Postcards:** `postcard-engine.js` — `PostcardCanvas` component, heritage postmark stamp (with fallback if asset missing).
- **Deploy:** `firebase.json` has `"public": "public"`. Deployable content is **only** what’s in `public/` (copied by `FIREBASE_FRESH_START.bat` or manually). Do not deploy from repo root.

**Important paths:**
- Root: `index.html`, `plogger.js`, `postboxAssets.js`, `postcard-engine.js`, `manifest.json`, `service-worker.js`, `404.html`, `firebase.json`, `.firebaserc`.
- `public/` — exact copy of above (minus firebase config) + `assets/` (icons, etc.). This is what Firebase serves.
- `assets/icons/` — PNGs for types (Edward VIII, Victorian Fluted, Guernsey, Airmail, etc.) + PWA icons + `heritage_postmark_stamp_1.png`.

---

## 3. What Was Done in This Session (Condensed)

- **Script loading:** Switched from nested `createElement` chain to synchronous `<script>` tags in `<head>` so `postboxAssets.js` loads before app init.
- **initApp():** Added missing `initApp()` call after Firebase setup (was causing white screen).
- **Version:** `APP_VERSION = '0.9.1'`, version badge in header.
- **Philately / Field Guide:** Updated `postboxAssets.js`: VR Fluted (500 pts, rarity 10), Edward VIII (300 pts), Jersey First Type (new, 1000 pts), Guernsey Blue (corporate blue, 50 pts), Airmail Blue (Prussian blue, 250 base). Added `visualMarkers`, `cipherDetails`, `validationQuestion` where specified.
- **Firebase deploy:** Root deploys were uploading 900–1273 files (docs, .git, etc.). Fixed by:
  - Creating `public/` and copying only app + assets.
  - Setting `firebase.json` to `"public": "public"`.
  - Using `FIREBASE_FRESH_START.bat` to build `public/` and deploy.
- **Helper scripts:** `Firebase_DEPLOY.bat`, `FIREBASE_FRESH_START.bat`, `CHECK_FIREBASE_DEPLOYMENT.bat`, etc. Some cleanup scripts may still be in repo.

---

## 4. Outstanding Issues (For Claude / Next Session)

1. **Icons not showing in Visual Picker (live site)**  
   - Likely: asset paths in `postboxAssets.js` (e.g. `assets/icons/...`) vs how they’re served from Firebase (e.g. root at heritage-postbox.web.app).  
   - Check: In browser on live site, do requests to e.g. `https://heritage-postbox.web.app/assets/icons/eviiir_cipher_design_1.png` return 200 or 404?  
   - Fix: Ensure `public/assets/icons/` has the same filenames as in `postboxTypes`, and that no base path is required (or add correct base path in app/config).

2. **Blue dot not pulsating**  
   - Pulsing is done with CSS class `.user-location-marker` and `::after` with `animation: pulsate`.  
   - Check: Is the user location marker rendered with that class in `MapView`? (Search for `user-location-marker` in `index.html`.)  
   - Possible: Class name typo, or Leaflet `divIcon` not applying the class to the DOM node that’s visible.

3. **Directions button not showing/working**  
   - Popups should include a button that does `window.open('geo:${lat},${lng}', '_blank')`.  
   - Check: In `index.html`, where popup content is built for user postboxes and for official postboxes — is the Directions button HTML present and correct?  
   - Possible: Popup content string typo, or `geo:` link not rendered (e.g. escaped or stripped).

---

## 5. Deployment Workflow (For Claude / User)

- **Update live site:**  
  1. Edit files in **repo root** (e.g. `index.html`, `postboxAssets.js`, `plogger.js`, etc.).  
  2. Run `FIREBASE_FRESH_START.bat` to refresh `public/` and deploy, **or** manually copy changed files into `public/` then run `Firebase_DEPLOY.bat`.  
  3. Do **not** set `firebase.json` back to `"public": "."` unless ignore/list is fixed; otherwise 900+ files will deploy again.

- **Git:** Commit from root. The `public/` folder can be gitignored or committed (current setup: it’s generated by script). If committed, keep it in sync with root before each deploy.

---

## 6. For Gemini (Architect)

- **Product:** v0.9.1 Philately Alpha is coded and deployed; UX on live site is partially broken (no icons in picker, no pulsing blue dot, no directions).
- **Next priorities:**  
  1. Fix live-site UX (icons, blue dot, directions) — see Section 4.  
  2. Optional: Re-run full v0.9.1 test checklist (version badge, Visual Mode, GPS, SatNav, Postcard) after fixes.  
  3. Decide whether to keep dual deploy (Firebase + GitHub Pages) or standardise on one.
- **Docs:** `docs/sessions/v0.9.1/` and other docs in repo. Progress/tracker docs may need a short “post-handover” update after fixes.

---

## 7. For Claude (Developer)

- **Codebase:** Single-page app in `index.html` (React via createElement, no JSX). Key deps: `postboxAssets.js`, `postcard-engine.js`; Leaflet and React loaded from CDN.
- **Fixes to do next:**  
  1. Verify and fix asset paths so icons load from `https://heritage-postbox.web.app/...` (or correct base).  
  2. Verify `.user-location-marker` is applied to the user position marker and CSS is loaded.  
  3. Verify map popup content includes the Directions button and correct `geo:` URL.
- **Deploy:** Always deploy from `public/` via `firebase.json`; use `FIREBASE_FRESH_START.bat` or equivalent so `public/` matches root before deploy.
- **Copyright:** Keep “© 2025 Insight Geospatial, Eurotech Marine Data Services Ltd.” in any new or edited files.

---

## 8. Quick Reference

| Item              | Value / path                                      |
|-------------------|---------------------------------------------------|
| Live (Firebase)   | https://heritage-postbox.web.app                  |
| Live (GitHub)     | https://barryward2070-dotcom.github.io/heritage-postbox/ |
| Deploy source     | `public/` (populated from root by script)        |
| Config            | `firebase.json` (public: "public"), `.firebaserc` |
| Main app          | `index.html` (initApp, PostboxLogger, MapView, etc.) |
| Types/assets      | `postboxAssets.js`                               |
| Postcards         | `postcard-engine.js`                             |

---

**End of handover.** Use this with Gemini for strategy and prioritisation, and with Claude (or next dev session) for implementation and deployment.
